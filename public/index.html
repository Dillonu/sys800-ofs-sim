<!DOCTYPE html>
<html>
<body>

<!--<form action="/runsim" method="post">-->
Federate1: <input id="f1" type="number" name="federateIds[]" value="0" required><br>
Federate2: <input id="f2" type="number" name="federateIds[]" value="0" required><br>
Count: <input id="c" type="number" name="count" value="100"><br>
Turns: <input id="t" type="number" name="turns" value="24"><br>
O Alg: <input id="o" type="text" name="o" value="d6,a,1"><br>
F Alg: <input id="f" type="text" name="f" value="n"><br>
<input type="button" value="Submit Sim" onclick="submitSim()"><br>
<input type="button" value="Run All Sims" onclick="runAllSims(100)"><br>
<input type="button" value="Run Test Sim" onclick="submitTestSim()"><br>
<input type="button" value="Submit Mean" onclick="submitMean()"><br>
<pre id="r" style="width:100%">Results displayed here.</pre>
<!--</form>-->

<script>
    function submit(url, msg, callback) {
        var xhr = new XMLHttpRequest();
        xhr.open("POST", url, true);
        xhr.setRequestHeader('Content-Type', 'application/json');
        xhr.onreadystatechange = function () {
            if (this.readyState != 4) return;

            if (this.status == 200) {
                var data = JSON.parse(this.responseText);

                document.getElementById("r").innerText = JSON.stringify(data, null, '\t');
                if (callback) callback();
                // we get the returned data
            }

            // end of state change: it can be after some time (async)
        };
        xhr.send(JSON.stringify(msg));
    }

    function submitSim() {
        submit("/runsim", {
            federateIds: [Number(document.getElementById("f1").value), Number(document.getElementById("f2").value)],
            count: Number(document.getElementById("c").value),
            turns: Number(document.getElementById("t").value),
            o: document.getElementById("o").value,
            f: document.getElementById("f").value
        });
    }

    function submitTestSim() {
        const count = Number(document.getElementById("c").value);
        const turns = Number(document.getElementById("t").value);
        const o = document.getElementById("o").value;
        const f = document.getElementById("f").value;

        function upper() {
            let t = 0;

            function _upper() {
                if (t < turns) {
                    submit("/runsim", {
                        federateIds: [0,0],
                        loc: [[3,0],[2,2]],
                        count: count,
                        turns: t,
                        o: o,
                        f: f
                    }, _upper);

                    t += 1;
                }
            }

            _upper();
        }

        upper();
    }

    function submitMean() {
        submit("/mean", {
            config: {
                federateIds: [Number(document.getElementById("f1").value), Number(document.getElementById("f2").value)]
            }
        });
    }

    function runAllSims(ids) {
        const count = Number(document.getElementById("c").value);
        const turns = Number(document.getElementById("t").value);
        const o = document.getElementById("o").value;
        const f = document.getElementById("f").value;

        function lower(i, callback) {
            let j = i;

            function _lower() {
                if (j < ids) {
                    submit("/runsim", {
                        federateIds: [i, j],
                        count: count,
                        turns: turns,
                        o: o,
                        f: f
                    }, _lower);

                    j += 1;
                } else {
                    callback();
                }
            }

            _lower();
        }

        function upper(callback) {
            let i = 0;

            function _upper() {
                if (i < ids) {
                    lower(i, _upper);

                    i += 1;
                } else {
                    callback();
                }
            }

            _upper();
        }

        // Disable all buttons:
        document.querySelectorAll("input").forEach((el) => {
            el.disabled = true;
        });
        // Run query:
        upper(function () {
            // Enable all buttons:
            document.querySelectorAll("input").forEach((el) => {
                el.disabled = false;
            });
        });
    }
</script>
</body>
</html>
